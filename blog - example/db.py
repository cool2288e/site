import sqlite3

DB_NAME = "little_nightmares_v2.db"

# --- ПІДКЛЮЧЕННЯ ДО БД ---
def get_db():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

# --- СТВОРЕННЯ ТА НАПОВНЕННЯ БД ---
def init_db():
    with get_db() as db:
        db.execute("""
        CREATE TABLE IF NOT EXISTS sections (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            slug TEXT UNIQUE NOT NULL
        )
        """)

        db.execute("""
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            text TEXT NOT NULL,
            image TEXT,
            section_id INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (section_id) REFERENCES sections(id)
        )
        """)

        check = db.execute("SELECT count(*) FROM sections").fetchone()[0]

        if check == 0:
            print("База пуста. Додаю розділи про Little Nightmares...")

            sections_data = [
                ("Персонажі", "characters"),
                ("Монстри", "monsters"),
                ("Локації", "locations"),
                ("Теорії", "theories")
            ]

            for name, slug in sections_data:
                db.execute("INSERT INTO sections (name, slug) VALUES (?, ?)", (name, slug))

            characters = [
                ("Шоста (Six)", "Шоста — головна героїня гри, крихітна дев'ятирічна дівчинка в яскраво-жовтому дощовику, яка озброєна лише запальничкою. Вона прокидається на самому дні Чрева і намагається знайти шлях на свободу. Шоста не є типовим добрим героєм: вона мовчазна, спостережлива і безжальна у своєму прагненні вижити. Протягом гри її переслідують страшні напади неконтрольованого голоду, які змушують її їсти все, що трапиться під руку — від щура в мишоловці до живого Нома. Зрештою, вона поглинає темну силу Леді, стаючи найнебезпечнішою істотою на кораблі.", "six.jpg", 1),
                ("Втікач (Runaway Kid)", "Втікач (або Хлопчик) — головний герой сюжетного доповнення «Таємниці Чрева» (Secrets of the Maw). Це хлопчик у синій кофтині з кайданом на правій нозі, який прокидається в затоплених глибинах Чрева. Його шлях іде паралельно з історією Шостої, і він дізнається набагато більше секретів цього жахливого місця. На жаль, його доля виявляється ще трагічнішою: наприкінці свого шляху він стикається з Леді, яка за допомогою магії перетворює його на Нома. Саме він стає тим самим добрим Номом, який пропонує сосиску голодній Шостій, і якого вона безжально з'їдає.", "kid.jpg", 1),
                ("Леді (The Lady)", "Леді — абсолютна володарка Чрева, яка контролює все, що відбувається на цьому жахливому підводному судні. Вона носить елегантне кімоно та білу порцелянову маску, яка приховує її справжнє обличчя. Леді володіє потужною темною магією: вона здатна висмоктувати життєву енергію, перетворювати дітей на Номів і левітувати у темряві. Вона панічно боїться свого власного відображення, тому в її покоях розбиті всі дзеркала. Її головна мета — підтримувати безперервний цикл роботи Чрева, куди прибувають Гості, щоб наїстися і стати джерелом енергії (або м'яса) для неї.", "lady.jpg", 1),
                ("Доглядач (The Janitor)", "Доглядач (його також називають Роджер) — моторошний сліпий чоловік із неймовірно довгими руками та короткими ногами. Його очі закриті шаром звисаючої шкіри, але це не робить його менш небезпечним. Завдяки феноменальному слуху та гострому нюху він здатен вистежити будь-яку дитину навіть у повній темряві. Його головне завдання — доглядати за механізмами Чрева, а також ловити дітей-втікачів, щільно замотувати їх у папір і відправляти на кухню по гаках як «свіже м'ясо» для Кухарів.", "janitor.jpg", 1),
                ("Кухарі (The Twin Chefs)", "Кухарі-близнюки — це огидні, гладкі та надзвичайно жорстокі брати, які відповідають за приготування їжі для Гостей. Вони носять моторошні маски, зшиті зі шкіри, які ледь приховують їхні власні потворні обличчя. Близнюки постійно кашляють, важко дихають і поводяться дуже агресивно, якщо помітять у своїх володіннях порушника. Вони постійно рубають м'ясо невідомого походження, готують величезні страви і є ключовою ланкою в жахливому харчовому конвеєрі Чрева.", "chefs.jpg", 1),
                ("Бабуся (The Granny)", "Бабуся — жахлива та мстива сутність, яка живе в затоплених, найтемніших підвалах Чрева (Глибинах). Колись вона, можливо, теж працювала на кораблі, але потім її покинули гнити у воді, де вона повністю здичавіла. Бабуся дуже швидко плаває під водою і постійно намагається схопити Втікача, руйнуючи хиткі платформи, на яких він стоїть. Хлопчику вдається перемогти її тільки завдяки кмітливості: він скидає у воду увімкнений телевізор, що призводить до смертельного удару струмом.", "granny.jpg", 1),
                ("Номи (Nomes)", "Номи — це маленькі, полохливі та миролюбні істотки з конусоподібними головами, які нагадують гриби. Вони ховаються по кутках Чрева і розбігаються при будь-якому шумі. Довгий час вважалося, що це просто місцеві мешканці корабля, але доповнення розкрило їхню страшну таємницю: Номи — це колишні людські діти. Леді використовувала чорну магію, щоб перетворити їх на цих покірних істот, змусивши їх вічно і бездумно працювати в котельнях, кидаючи вугілля в печі для підтримки роботи двигунів Чрева.", "nome.jpg", 1)
            ]

            locations = [
                ("В'язниця (The Prison)", "Найнижчий рівень Чрева і стартова локація гри. Тут Шоста прокидається у валізі. У цій локації ми вчимося ховатися в тіні, обходити перші пастки-очі, пробираємося повз сплячих дітей у клітках і вперше стикаємося з жахливим Доглядачем.", "prison.jpg", 3),
                ("Лігво (The Lair)", "Володіння Доглядача. Це моторошне місце, завалене старими іграшками, валізами та клітками. Тут ми розв'язуємо просторові головоломки, ховаємося від довгих рук сліпого монстра і врешті-решт перемагаємо його, відрубавши йому руки дверима.", "lair.jpg", 3),
                ("Кухня (The Kitchen)", "Царство жорстоких Кухарів-близнюків. У цій локації ми постійно ховаємося під столами, бігаємо по полицях із посудом і використовуємо гаки для м'яса, щоб пересуватися під стелею. Головна мета — непомітно прокрастися і не потрапити Кухарям в суп.", "kitchen.jpg", 3),
                ("Гостьова зона (The Guest Area)", "Розкішна, але огидна їдальня в японському стилі. Сюди прибувають масивні Гості, щоб безперервно їсти. Нам доводиться бігти прямо по їхніх столах, ухиляючись від жадібних рук, і тікати від цілої хвилі розлючених монстрів.", "guest_area.jpg", 3),
                ("Покої Леді (The Lady's Quarters)", "Фінальна локація гри. Елегантні кімнати, заставлені розбитими дзеркалами та манекенами. Тут ми крадемося за спиною моторошної Леді, знаходимо єдине ціле дзеркало і використовуємо його у фінальній битві, щоб відбивати світло на господиню Чрева.", "lady_room.jpg", 3)
            ]

            theories = [
                ("1. Нескінченна часова петля (Доля Моно)", "Це одна з найпопулярніших і найтрагічніших теорій, яка підтвердилася у фіналі Little Nightmares II. Згідно з нею, Моно, хлопчик у паперовому пакеті, приречений на вічні страждання. Після того як Шоста зраджує його і відпускає руку над прірвою у Сигнальній Вежі, він падає на дно з м'яса та очей. З роками, під впливом викривленого часу Вежі, Моно виростає і перетворюється на Тонку Людину (The Thin Man) — того самого монстра, від якого він намагався втекти. Коли новий Моно приходить у Бліде Місто, цикл повторюється знову і знову.", "", 4),
                ("2. Чрево — це ферма з вирощування м'яса", "Якщо уважно придивитися до подій першої частини гри, можна зрозуміти жахливу мету Чрева (The Maw). Це не просто ресторан для багатіїв. Гості, які прибувають туди і жадібно поглинають їжу, самі стають цією їжею. Леді змушує Кухарів відгодовувати Гостей до неймовірних розмірів, після чого їх вбивають і переробляють на сосиски та стейки для наступної партії відвідувачів. Це безперервний конвеєр обжерливості, який підтримує життя Чрева.", "", 4),
                ("3. Шоста — наступниця Леді", "Багато гравців помітили портрети дівчинки у кімнатах Леді, що породило теорію: Шоста може бути донькою Леді, яку та викинула через свою одержимість красою. Проте є й інший варіант. У фіналі гри Шоста не просто вбиває Леді, вона її з'їдає, переймаючи її темну магію. Коли Шоста йде коридором, висмоктуючи життя з Гостей, вона де-факто стає новою господаркою Чрева. Її жахливий голод — це прокляття, яке передається від однієї господині до іншої.", "", 4),
                ("4. Сім смертних гріхів", "Світ Little Nightmares глибоко символічний. Фанатська спільнота помітила, що монстри уособлюють класичні людські вади. Гості — це абсолютна Обжерливість. Доглядач (Сліпий) з його любов'ю до колекціонування дітей та іграшок — Жадібність. Леді, яка розбиває всі дзеркала через страх перед своїм обличчям — Гординя. А сама Шоста, з її неконтрольованим голодом і холоднокровністю, поступово вбирає в себе ці гріхи, перетворюючись на найстрашнішого монстра з усіх.", "", 4),
                ("5. Справжня природа Номів", "Довгий час Номи вважалися просто милими мешканцями Чрева. Але в DLC \"Secrets of the Maw\" розкривається моторошна правда: Номи — це насправді діти, яких Леді перетворила за допомогою своєї чорної магії, щоб вони беззаперечно працювали в котельнях. Ця теорія робить момент з основної гри, коли Шоста відмовляється від сосиски і з'їдає живого Нома (яким виявився хлопчик-Втікач), мабуть, найтемнішим епізодом в історії гри.", "", 4),
                ("6. Око керує всім (М'ясні стіни)", "Всюди у світі гри — на стінах Чрева, на телевізорах, у головоломках — ми бачимо символ Ока. Теорія стверджує, що справжнім лиходієм є не Леді чи Тонка Людина, а гігантська космічна сутність, що складається з пульсуючого м'яса та безлічі очей. Її серцевина знаходиться у Сигнальній Вежі. Ця сутність живиться дитячими страхами та викривляє реальність навколо, а Леді та Тонка Людина — лише її маріонетки-наглядачі.", "", 4),
                ("7. Походження Жовтого дощовика", "Жовтий дощовик Шостої — найвпізнаваніший символ гри. Але звідки він взявся? У мобільній грі-приквелі Very Little Nightmares ми граємо за іншу дівчинку в такому ж дощовику. У фіналі вона героїчно гине, падаючи зі скелі, і залишає дощовик у воді. Теорія свідчить, що Шоста (яка весь цей час таємно йшла за нею) знайшла його і вдягнула на честь загиблої подруги, зробивши дощовик своєрідним символом виживання.", "", 4),
                ("8. Ким був Повішений чоловік?", "На самому початку першої гри Шоста прокидається і відразу натрапляє на кімнату, де зі стелі звисає повішений чоловік із неприродно довгими ногами. Хто він такий? Фанати сперечаються досі. Одні вважають, що це попередній господар Чрева або так званий Дзвінар (The Bellman) — концептуальний персонаж, якого вирізали з фінальної версії гри. Інша, більш моторошна версія: це був чоловік Леді (або навіть батько Шостої), який просто не зміг витримати жахів цього світу і наклав на себе руки.", "", 4)
            ]

            all_posts = characters + locations + theories
            for title, text, image, s_id in all_posts:
                db.execute("INSERT INTO posts (title, text, image, section_id) VALUES (?, ?, ?, ?)", (title, text, image, s_id))

            db.commit()
            print("Готово! Базу заповнено крутим лором.")

# --- ФУНКЦІЇ ОТРИМАННЯ ДАНИХ ---
def get_blog_sections():
    with get_db() as db:
        return db.execute("SELECT * FROM sections").fetchall()

def get_section_by_slug(section_slug):
    with get_db() as db:
        return db.execute("SELECT * FROM sections WHERE slug = ?", (section_slug,)).fetchone()

def get_section_by_id(section_id):
    with get_db() as db:
        return db.execute("SELECT * FROM sections WHERE id = ?", (section_id,)).fetchone()

def get_section_posts(section_id):
    with get_db() as db:
        # ОСЬ ЦЯ МАГІЯ ВИВОДИТИМЕ НОВІ ПОСТИ ЗВЕРХУ: ORDER BY id DESC
        return db.execute("SELECT * FROM posts WHERE section_id = ? ORDER BY id DESC", (section_id,)).fetchall()

# --- ФУНКЦІЇ ЗАПИСУ ДАНИХ ---
def create_new_post(title, text, image, section_id):
    with get_db() as db:
        db.execute("""
            INSERT INTO posts (title, text, image, section_id)
            VALUES (?, ?, ?, ?)
        """, (title, text, image, section_id))
        db.commit()

# --- ЗАПУСК ---
if __name__ == "__main__":
    init_db()